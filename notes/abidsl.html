<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link href="https://fonts.googleapis.com/css?family=Maven+Pro:400,500&amp;subset=latin-ext,vietnamese" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Dancing+Script:400,700&amp;subset=vietnamese" rel="stylesheet">
  <meta name="google-site-verification" content="8zqeFQNuNAWS7ye6oN69hdEeYC_RsDyAlhht79xtAQo" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content="/build-notes/assets/img/banner.png" />

  

  <title>
    
      Spack&#39;S Domain Specific Language for ABI | BUILD Notes
    
  </title>

  

  <!-- page's cover -->
  
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1234">
    <meta property="og:image:height" content="592">
  

  

  <link rel="shortcut icon" type="image/x-icon" href="/build-notes/assets/img/favicon.ico">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="/build-notes/assets/css/main.css">
  <link rel="stylesheet" href="/build-notes/assets/css/thi_scss.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@200;400;600&display=swap" rel="stylesheet"> 

  
    
      <link rel="stylesheet" href="/build-notes/assets/css/post.css">
    
  

  

  <link rel="stylesheet" href="/build-notes/assets/css/syntax.css">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/build-notes/feed.xml">
  <link rel="sitemap" type="application/xml" title="Sitemap" href="/build-notes/sitemap.xml">
  
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Spack‚ÄôS Domain Specific Language for ABI" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Goals" />
<meta property="og:description" content="Goals" />
<link rel="canonical" href="/build-notes/notes/abidsl" />
<meta property="og:url" content="/build-notes/notes/abidsl" />
<meta property="og:site_name" content="BUILD Notes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-22T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Spack‚ÄôS Domain Specific Language for ABI" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-22T00:00:00+00:00","datePublished":"2022-04-22T00:00:00+00:00","description":"Goals","headline":"Spack‚ÄôS Domain Specific Language for ABI","mainEntityOfPage":{"@type":"WebPage","@id":"/build-notes/notes/abidsl"},"url":"/build-notes/notes/abidsl"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
	<header>
  
    <div class="container">
  <a href="#" data-activates="slide-out" class="button-collapse top-nav full hide-on-large-only">
    <i class="material-icons">menu</i>
  </a>
</div>
<div id="slide-out" class="side-nav fixed">
  <div>
    <div class="userView thi-userView">
      <div class="background"></div>
        <a href="/build-notes/">
          <img style="display:inherit;" class="circle z-depth-2" src="/build-notes/assets/img/napkins.png">
        </a>
      <span style="font-size: larger;" class="white-text name">buildsi/build-notes</span>
      <span class="white-text email"><a style="color: #bdbdbd;" href="https://github.com/buildsi/build-notes"></a></span>
    </div>
  </div>
  <div style="padding: 10px;">
    <form action="/build-notes/search" method="get">
      <input class="search-sidebar" type="search" name="q"  placeholder="search something?" autofocus>
      <input type="submit" value="Search" style="display: none;">
    </form>
  </div>
  <div id="toc-bar">
    <div class="toc-bar-title">
      In this post
    </div>
    <ol id="toc-sidebar">
  <li><a href="#goals">Goals</a></li>
  <li><a href="#possible-functions">Possible Functions</a></li>
  <li><a href="#package-requirements">Package Requirements</a></li>
  <li><a href="#use-cases">Use-cases</a></li>
  <li><a href="#key-caveats">Key Caveats</a></li>
  <li><a href="#abi-directives">ABI directives</a></li>
  <li><a href="#variants">Variants</a></li>
  <li><a href="#design-features">Design features</a></li>
  <li><a href="#related-functionality">Related Functionality</a></li>
  <li><a href="#related-work">Related Work</a></li>
  <li><a href="#proposed-paper-titles">Proposed Paper Titles</a></li>
  <li><a href="#talk-outline">Talk Outline</a>
    <ol>
      <li><a href="#concrete-examples">Concrete Examples</a></li>
      <li><a href="#open-ended-rfc">Open-Ended RFC</a></li>
      <li><a href="#related-work-1">Related Work</a></li>
    </ol>
  </li>
</ol>
  </div>
</div>

  
</header>
<main>
  <div class="container">
    <div id="post-info">
      <h3>Spack'S Domain Specific Language for ABI</h3>
      <span>
        Posted on
        <span style="display: initial;" class="cat-class">22/04/2022</span>
        | <a style="float:right" href="https://github.com/buildsi/build-notes/edit/main/_notes/abidsl.md" target="_blank">üóíÔ∏è Edit on GitHub</a>
      </span>
    </div>

    <div class="divider"></div>
    <div class="row thi-post">
      <div class="col s12">
        <h2 id="goals">Goals</h2>

<ul>
  <li>Splicing in new spec should satisfy all symbols.</li>
</ul>

<h2 id="possible-functions">Possible Functions</h2>

<p><code class="language-plaintext highlighter-rouge">abi_spec()</code> Called when a splice is requested. Only called on concrete spec. Recursive check on entire DAG.</p>

<p><code class="language-plaintext highlighter-rouge">abi_match()</code> Could return a list/range all specs satisfied by given spec. Similar to provides.</p>

<p>Infers abstract constraints.<br />
Writes edge attributes.</p>

<h2 id="package-requirements">Package Requirements</h2>

<ul>
  <li>Which dependencies matter for ABI.</li>
  <li>Package needs to state which variants matter and in which direction.</li>
</ul>

<h2 id="use-cases">Use-cases</h2>

<ul>
  <li>Swapping MPIs</li>
  <li>Using MPITrampoline and wi4mpi</li>
  <li>transitive dependencies and ABI breaks</li>
  <li>transitive ABI exposure
    <ul>
      <li>nholmann json exposes its boost version to deps</li>
    </ul>
  </li>
  <li>diamond ABI compatibility: if you replace C with C‚Äô and C‚Äô requires D‚Äô, D‚Äô
must be compatible with D
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   A
  / \
 B   C
  \ /
   D
</code></pre></div>    </div>
  </li>
  <li>Splice MKL in for BLAS (i.e. libnames are totally different)</li>
  <li><a href="https://abi-laboratory.pro/?view=timeline&amp;l=zlib">zlib</a></li>
  <li>Less stable examples:
    <ul>
      <li><a href="https://abi-laboratory.pro/index.php?view=timeline&amp;l=capnproto">Cap‚ÄônProto</a></li>
      <li><a href="https://abi-laboratory.pro/index.php?view=timeline&amp;l=hdf5">hdf5</a></li>
    </ul>
  </li>
</ul>

<h2 id="key-caveats">Key Caveats</h2>

<ul>
  <li>Mixed languages: i.e. a lua dependency doesn‚Äôt break C ABI, but has an internal ABI break.</li>
  <li>You may not care about variants or they may be critical.</li>
  <li>Need to know when dependencies affect abi.</li>
  <li>Adding variants might affect ABI but subtracting doesn‚Äôt, and vice-versa.</li>
</ul>

<h2 id="abi-directives">ABI directives</h2>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">MyPackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">canonicalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">add_compiler_and_runtime_info</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
		<span class="k">def</span> <span class="nf">get_abi_ver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
      <span class="c1"># Should return spec and whether or not variants, deps
</span>      <span class="c1"># matter.
</span>    	<span class="k">return</span> <span class="n">version</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># need a dependency listed?
</span>		<span class="n">abi_propagates</span><span class="p">(</span><span class="n">build</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
		<span class="n">abi_backward</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="variants">Variants</h2>

<p><code class="language-plaintext highlighter-rouge">boost+graph+json</code> satisfies <code class="language-plaintext highlighter-rouge">boost</code>, <code class="language-plaintext highlighter-rouge">boost+graph</code>, and <code class="language-plaintext highlighter-rouge">boost+json</code><br />
Similar for ‚Äúwithout‚Äù.</p>

<p>If asked about an unknown variant, does not satisfy/trigger rebuild.</p>

<p><code class="language-plaintext highlighter-rouge">graph=*</code> is ‚ÄúI don‚Äôt care.‚Äù</p>

<ol>
  <li>you have a <code class="language-plaintext highlighter-rouge">boost</code> that was built with <code class="language-plaintext highlighter-rouge">+graph</code> but the package doesn‚Äôt know about it.</li>
  <li>You want to splice in a <code class="language-plaintext highlighter-rouge">boost~graph</code>.</li>
  <li>This will work, but it may cause issues.
    <ul>
      <li>because <code class="language-plaintext highlighter-rouge">boost~graph</code> satisfies <code class="language-plaintext highlighter-rouge">boost</code></li>
      <li>(query satisfies requirement)</li>
    </ul>
  </li>
  <li>You have a <code class="language-plaintext highlighter-rouge">boost~graph</code></li>
  <li>You want to splice in a <code class="language-plaintext highlighter-rouge">boost+graph</code>.</li>
  <li>This will fail, but it shouldn‚Äôt.</li>
</ol>

<p>Requirements of the dependents are really what matters.</p>

<h2 id="design-features">Design features</h2>

<ul>
  <li>Should be directional</li>
  <li>Ideally use specs and don‚Äôt create a new model.</li>
</ul>

<h2 id="related-functionality">Related Functionality</h2>

<ul>
  <li>Abstract constraints on all edges. Can be inferred from <code class="language-plaintext highlighter-rouge">package.py</code> <code class="language-plaintext highlighter-rouge">depends_on(target)</code>.</li>
</ul>

<h2 id="related-work">Related Work</h2>

<p>Inferred types<br />
Parameterized types<br />
Type checkers
Covariants and contravariants of return types in Java. (e.g. Caller has to be compatible with return type.)</p>

<h2 id="proposed-paper-titles">Proposed Paper Titles</h2>

<p>Expressing ABI in package managers.</p>

<h2 id="talk-outline">Talk Outline</h2>

<ol>
  <li>Discuss splicing‚Äìneed a happy medium between package-level stuff and live at head.</li>
  <li>Why keeping provenance is important</li>
  <li>Splicing: keep all metadata.</li>
  <li>Symbols (static analysis) and ABI specs (our new DSL)</li>
  <li>We‚Äôre not always going to have symbols, so we need a way to describe changes
the programmer made that impacts the ABI.</li>
  <li>We want a semver but more specific.</li>
</ol>

<ul>
  <li>Spack ought to take care of everything to do with the compiler, arch, os, etc.</li>
  <li>This is more focused on package and depenedency ABI.</li>
</ul>

<h3 id="concrete-examples">Concrete Examples</h3>

<ul>
  <li>Container MPI bind-mounting use case.</li>
  <li>What would the ABI specs for the MPI look like?</li>
</ul>

<h3 id="open-ended-rfc">Open-Ended RFC</h3>

<ul>
  <li>Pruning</li>
</ul>

<h3 id="related-work-1">Related Work</h3>

<p>CUG: Finding and Binding<br />
<code class="language-plaintext highlighter-rouge">spack external find</code>: If we can describe the ABI of what we find, we know
what can be spliced and what can‚Äôt.</p>


      </div>
    </div>

    <div class="tag-list">
      
      
      
      <a class="tag-chip" href="/build-notes/tags#dsl"><div class="chip z-depth-1">dsl</div></a>
      
    </div>
    <style type="text/css">
.related-posts{
  border: 3px dotted #2e87e7;
  border-radius: 5px;
  margin: 20px 0;
  padding: 10px 10px 0 10px;
}
.related-posts span{
  font-size: 130%;
  font-weight: 500;
  color: #2e87e7;
}
.related-posts ul{
  margin-top: 5px!important;
}
.thi-icon{
  float: left;
  line-height: inherit;
  margin-right: 5px;
  margin-left: 2px;
  color: #2e87e7;
}
</style>

<div class="related-posts">
  <i class="material-icons thi-icon">grade</i><span>Related Notes</span>
  
  <ul>
    
    

    
    
      
    
  </ul>
</div>

    <form action="/build-notes/search" method="get">
	<input type="search" name="q"  placeholder="Search for..." autofocus>
	<input type="submit" value="Search" style="display: none;">
</form>

  </div>
</main>

	<script src="/build-notes/assets/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript">
  jQuery(document).ready(function($){
    // browser window scroll (in pixels) after which the "back to top" link is shown
    var offset = 300,
      //browser window scroll (in pixels) after which the "back to top" link opacity is reduced
      offset_opacity = 1200,
      //duration of the top scrolling animation (in ms)
      scroll_top_duration = 700,
      //grab the "back to top" link
      $back_to_top = $('.cd-top');

    //hide or show the "back to top" link
    $(window).scroll(function(){
      ( $(this).scrollTop() > offset ) ? $back_to_top.addClass('cd-is-visible') : $back_to_top.removeClass('cd-is-visible cd-fade-out');
      // if( $(this).scrollTop() > offset_opacity ) { 
      //  $back_to_top.addClass('cd-fade-out');
      // }
    });

    //smooth scroll to top
    $back_to_top.on('click', function(event){
      event.preventDefault();
      $('body,html').animate({
        scrollTop: 0 ,
        }, scroll_top_duration
      );
    });

  });
</script>
<style type="text/css">
.cd-top {
  display: inline-block;
  height: 50px;
  width: 50px;
  position: fixed;
  bottom: 2%;
  right: 2%;
  border-radius: 40px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
  /* image replacement properties */
  overflow: hidden;
  text-indent: 100%;
  white-space: nowrap;
  background: #bbb url(/build-notes/assets/img/cd-top-arrow.svg) no-repeat center 50%;
  visibility: hidden;
  opacity: 0;
  -webkit-transition: opacity .3s 0s, visibility 0s .3s;
  -moz-transition: opacity .3s 0s, visibility 0s .3s;
  transition: opacity .3s 0s, visibility 0s .3s;
}
.cd-top.cd-is-visible, .cd-top.cd-fade-out, .no-touch .cd-top:hover {
  -webkit-transition: opacity .3s 0s, visibility 0s 0s;
  -moz-transition: opacity .3s 0s, visibility 0s 0s;
  transition: opacity .3s 0s, visibility 0s 0s;
}
.cd-top.cd-is-visible {
  /* the button becomes visible */
  visibility: visible;
  opacity: 1;
}
.cd-top.cd-fade-out {
  /* if the user keeps scrolling down, the button is out of focus and becomes less visible */
  opacity: .5;
}
.no-touch .cd-top:hover {
  background-color: #e86256;
  opacity: 1;
}
</style>

<a href="#0" class="cd-top">Top</a>

	<footer class="page-footer teal">
  <div class="footer-copyright">
    <div class="container text-white">
          <a class="waves-effect" href="/build-notes/tags">Tags</a> | <a class="waves-effect" href="/build-notes/categories">Categories</a> | <a class="waves-effect" href="https://github.com/buildsi/build-notes">GitHub</a>
    </div>
  </div>
</footer>

<script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>


  
    <script src="/build-notes/assets/js/post.js"></script>
  



<script src="/build-notes/assets/js/main.js"></script>

</body>
</html>